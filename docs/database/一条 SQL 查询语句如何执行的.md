一条 SQL 查询语句如何执行的

在平常的开发中，可能很多人都是 CRUD，对 SQL 语句的语法很熟练，但是说起一条 SQL 语句在 MySQL 中是怎么执行的却浑然不知，今天大彬就由浅入深，带大家一点点剖析一条 SQL 语句在 MySQL 中是怎么执行的。

比如你执行下面这个 SQL 语句时，我们看到的只是输入一条语句，返回一个结果，却不知道 MySQL 内部的执行过程：

```mysql
mysql> select * from T where ID=10；
```

在剖析这个语句怎么执行之前，我们先看一下 MySQL 的基本架构示意图，能更清楚的看到 SQL 语句在 MySQL 的各个功能模块中的执行过程。

![](http://img.topjavaer.cn/img/202406030841887.png)

整体来说，MySQL 可以分为 Server 层和存储引擎两部分。

Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

### 连接器

如果要操作 MySQL 数据库，我们必须使用 MySQL 客户端来连接 MySQL 服务器，这时候就是服务器中的连接器来负责根客户端建立连接、获取权限、维持和管理连接。

在和服务端完成 TCP 连接后，连接器就要认证身份，需要用到用户名和密码，确保用户有足够的权限执行该SQL语句。

### 查询缓存

建立完连接后，就可以执行查询语句了，来到第二步：查询缓存。

MySQL 拿到第一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中，如果你的查询能够直接在这个缓存中找到 key，那么这个 value 就会被直接返回给客户端。

如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。你可以看到，如果查询命中缓存，MySQL 不需要执行后面的复杂操作，就可以直接返回结果，这个效率会很高。

### 分析器

如果没有命中缓存，就要开始真正执行语句了，MySQL 首先会对 SQL 语句做解析。

分析器会先做 “词法分析”，MySQL 需要识别出 SQL 里面的字符串分别是什么，代表什么。

做完之后就要做“语法分析”，根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法。若果语句不对，就会收到错误提醒。

### 优化器

经过了分析器，MySQL 就知道要做什么了，但是在开始执行之前，要先经过优化器的处理。

比如：优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。

MySQL 会帮我去使用他自己认为的最好的方式去优化这条 SQL 语句，并生成一条条的执行计划，比如你创建了多个索引，MySQL 会依据**成本最小原则**来选择使用对应的索引，这里的成本主要包括两个方面, IO 成本和 CPU 成本。

### 执行器

执行优化之后的执行计划，在开始执行之前，先判断一下用户对这个表有没有执行查询的权限，如果没有，就会返回没有权限的错误；如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。

### 存储引擎

执行器将查询请求发送给存储引擎组件。

存储引擎组件负责具体的数据存储、检索和修改操作。

存储引擎根据执行器的请求，从磁盘或内存中读取或写入相关数据。

### 返回结果

存储引擎将查询结果返回给执行器。

执行器将结果返回给连接器。

最后，连接器将结果发送回客户端，完成整个执行过程。